local ExpModule = {}

local function LoadExpoiterInfo(exploiter: table): table    
    local km = exploiter.KillMethod
    local info = {}
    if km == 1 then
        info.TPTimes = 1
        info.Damage = 100
        info.studsAway_min = 4
        info.studsAway_max = 8
    elseif km == 2 then
        info.TPTimes = 1
        info.Damage = 100
        info.studsAway_min = 3.4
        info.studsAway_max = 6.23
    end
    return (info)
end




local function ExpModule:SpawnFakeCharacter()
    local exploiter = FRAMING_RESTORE_PLAYER.special_items.Exploiter
    local noobPlayer = game:GetObjects('rbxassetid://4446576906')[1]
    noobPlayer.Name = exploiter.Name
    local noobHud = cloned:Clone()
    noobHud.Parent = noobPlayer.Head
    noobHud.HealthDisplay.TextLabel.Text = 100
    noobHud.TimeDisplay.TextLabel.Text = exploiter.TimeAlive
    noobHud.TimeDisplay.TextLabel.TextColor3 = Color3.new(228, 248, 154)
    noobPlayer.Parent = workspace
    local randomX = math.random(-10,20)
    local randomZ = math.random(-10,20)
    noobPlayer.HumanoidRootPart.CFrame = spawnLocation.CFrame * CFrame.new(randomX,0,randomZ)
    noobPlayer.HumanoidRootPart.Anchored = false
    local killConnectionKeybind
    local characterBodyColors = noobPlayer:FindFirstChild("Body Colors")
    local function ApplyBodyColors()
        for i,v in exploiter.BodyColors do
            characterBodyColors[tostring(i).."Color3"] = v
        end
    end
    local function ApplyMeshes()
        local function GetMeshStuff(itemId)
            local model = LoadModel(itemId)
            if model then
                local potential = model[1]
                potential.Parent = workspace:FindFirstChild("Folder") or Instance.new("Folder", workspace)
                local meshPart = potential:FindFirstChildWhichIsA("MeshPart")
                if meshPart then
                    return meshPart.MeshId
                end
            end
        end
        local useMeshes = math.random(1,2) == 1 and true
        
        for partName, itemId in pairs(exploiter.Meshes) do
            if (exploiter.useMeshChance and useMeshes) or tostring(itemId):lower() ~= "blocky" then
    
                local meshId = itemId --GetMeshStuff(itemId)
                if meshId then
                    if tostring(meshId):find("?id=") then
                        meshId = meshId:split("?id=")[2]
                    end
                    
                    local charMesh = Instance.new("CharacterMesh")
                    if partName:find(" ") then
                        partName = partName:gsub(" ", "") -- Remove any spaces
                    end
                    charMesh.BodyPart =  Enum.BodyPart[partName]  -- numeric
                    charMesh.MeshId = tonumber(meshId)
    
                    charMesh.Parent = noobPlayer
                end
            end
        end
    end
    local function ApplyHats()
        
        local function ApplyHat(hatName)
            local hairAsset = LoadModel(HatData[hatName].ID)
            local handle = hairAsset:FindFirstChild("Handle", true)
            hairAsset.Parent = noobPlayer
            print(hairAsset, handle, hatName, HatData[hatName].ID)
            for _,child in ipairs(handle:GetChildren()) do
                if child:IsA("Weld") or child:IsA("WeldConstraint") then
                    child:Destroy()
                end
            end
    
            local weld = Instance.new("Weld")
            weld.Part0 = handle
            weld.Part1 = noobPlayer.Head
            weld.C0 = HatData[hatName].Offset
            weld.Parent = handle
        end
        for HatName,HatToggle in exploiter.Hats do
            if HatToggle then
                ApplyHat(HatName)
            end
        end
    end
    
    local function ApplySword()
        local swordsFolder = LoadModel(99858329064078)
        print(swordsFolder)
        swordsFolder.Parent = game:GetService("ReplicatedStorage")
        local newSword = swordsFolder:FindFirstChild("Default Sword"):Clone()
        newSword.Parent = noobPlayer

        local handle = newSword:FindFirstChild("Handle")
        handle.Anchored = false
        handle.CanCollide = false
        local torso = noobPlayer:FindFirstChild("Torso")
        local rightShoulder = torso:FindFirstChild("Right Shoulder")
        rightShoulder.C0 = rightShoulder.C0 * CFrame.Angles(0, 0, math.rad(90))
        local handle = newSword:FindFirstChild("Handle")
        local rightArm = noobPlayer:FindFirstChild("Right Arm")
        local swordWeld = Instance.new("Weld")
        swordWeld.Name = "SwordWeld"
        swordWeld.Part0 = rightArm
        swordWeld.Part1 = handle
        swordWeld.C0 = CFrame.new(0, -1, -1.6) * CFrame.Angles(math.rad(180), math.rad(0),math.rad(90))
        swordWeld.Parent = rightArm

    end
    
    local function ApplyShirtAndPants()
        local shirt,pants = Instance.new("Shirt"), Instance.new("Pants")
        shirt.Parent,pants.Parent = noobPlayer, noobPlayer
        shirt.ShirtTemplate = "http://www.roblox.com/asset/?id="..tostring(exploiter.Shirt)
        pants.PantsTemplate = "http://www.roblox.com/asset/?id="..tostring(exploiter.Pants)
    end
    local function CreateKillLog(Magnitude)
        local studEvent = ReplicatedStorage:FindFirstChild("Remotes"):FindFirstChild("StudEvent")
        local connection = studEvent.OnClientEvent
        local connections = getconnections(connection)
        if #connections > 0 then
            connection = connections[1]
            local func = connection.Function
            local actualUsername = FRAMING_RESTORE_PLAYER['ActualUsername']
            if func then
                -- Ensure values are not nil
                local killerName = exploiter.Name or "Unknown Killer"
                local victimName = actualUsername or "Unknown Victim"
                
                Magnitude = math.floor(Magnitude*100)/100
                func({Name = victimName}, {Name = killerName}, Magnitude, tostring(currentTime or "0"))
            end
        end
    end

    local function HurtPlayer()
        local root = LocalPlayer.Character.HumanoidRootPart
        local magnitude = 0
        local Humanoid = root.Parent:FindFirstChild("Humanoid")
        local onKillConnection;onKillConnection = Humanoid.Died:Connect(function()
            noobHud.TimeDisplay.TextLabel.Text += 1
            CreateKillLog(magnitude)
            desiredTime = 0
        end)

        local info = LoadExpoiterInfo(exploiter)
        local randomX, randomZ = math.random(info.studsAway_min,info.studsAway_max),math.random(info.studsAway_min,info.studsAway_max)
        local tw = TweenService:Create(noobPlayer.HumanoidRootPart, TweenInfo.new(0.025), {CFrame = root.CFrame * CFrame.new(randomX,0,randomZ)})
        tw:Play()
        tw.Completed:Wait()
        for i=1,info.TPTimes do
            noobPlayer.HumanoidRootPart.CFrame = root.CFrame * CFrame.new(randomX,0,randomZ)
            magnitude = (noobPlayer.HumanoidRootPart.Position -  root.Position).Magnitude
            task.wait(.125)
            Humanoid.Health -= (info.Damage)
            cloned.HealthDisplay.TextLabel.Text = LocalPlayer.Character.Humanoid.Health
            TeleportFrame.Visible = isAlive()
            if Humanoid.Health > (Humanoid.MaxHealth * .25) then
    			cloned.HealthDisplay.TextLabel.TextColor3 = Color3.fromRGB(202, 248, 216)
    		else 
    			cloned.HealthDisplay.TextLabel.TextColor3 = Color3.fromRGB(248, 169, 169)
    		end
        end
        task.wait(math.random(40,70)/100)
        
        noobPlayer:Destroy()
        onKillConnection:Disconnect()
        killConnectionKeybind:Disconnect()
    end
    
    local function MakeKeybindConnection()
        killConnectionKeybind = UserInputService.InputBegan:Connect(function(input, ige)
            if ige then return end
            if input.KeyCode == exploiter.AttackKeybind then
                HurtPlayer()
            end
        end)
    end
    ApplySword()
    if exploiter.UseCustomAvatar then
        ApplyShirtAndPants()
        ApplyHats()
        ApplyMeshes()
        ApplyBodyColors()
    else
        ChangePlayer(noobPlayer, exploiter.Name)
    end
    for i,v in noobPlayer:GetDescendants() do
        if v:IsA("BasePart") then
            v.CanCollide = false
        end
    end
    MakeKeybindConnection()
end


return ExpModule


